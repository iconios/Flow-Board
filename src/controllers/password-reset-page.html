<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Password Reset</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background: linear-gradient(135deg, #e2dfe6 0%, #aeb0b4 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        width: 100%;
        max-width: 500px;
        overflow: hidden;
      }

      .header {
        background: #4a6cf7;
        color: white;
        padding: 25px;
        text-align: center;
      }

      .header h1 {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 5px;
      }

      .header p {
        font-size: 14px;
        opacity: 0.9;
      }

      .form-container {
        padding: 30px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
        font-size: 14px;
      }

      .form-group input {
        width: 100%;
        padding: 14px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 15px;
        transition: border-color 0.3s;
      }

      .form-group input:focus {
        border-color: #4a6cf7;
        outline: none;
        box-shadow: 0 0 0 2px rgba(74, 108, 247, 0.2);
      }

      .password-requirements {
        background-color: #f8f9fa;
        border-left: 4px solid #4a6cf7;
        padding: 12px 15px;
        margin-top: 5px;
        border-radius: 4px;
        font-size: 13px;
        color: #555;
      }

      .password-requirements ul {
        padding-left: 20px;
        margin-top: 5px;
      }

      .password-requirements li {
        margin-bottom: 3px;
      }

      .password-requirements li.valid {
        color: #28a745;
      }

      .password-requirements li.valid::before {
        content: "✓ ";
      }

      button {
        width: 100%;
        padding: 14px;
        background: #4a6cf7;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s;
      }

      button:hover {
        background: #3a5cd8;
      }

      button:disabled {
        background: #b0b0b0;
        cursor: not-allowed;
      }

      .message {
        padding: 15px;
        margin-top: 20px;
        border-radius: 6px;
        text-align: center;
        font-size: 14px;
        display: none;
      }

      .success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
        display: block;
      }

      .error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        display: block;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
        margin-right: 10px;
        vertical-align: middle;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .token-info {
        background-color: #f8f9fa;
        padding: 10px 15px;
        border-radius: 6px;
        margin-bottom: 20px;
        font-size: 14px;
        color: #555;
        word-break: break-all;
      }

      .password-strength {
        margin-top: 8px;
        height: 5px;
        border-radius: 3px;
        background: #eee;
        overflow: hidden;
      }

      .password-strength-bar {
        height: 100%;
        width: 0%;
        transition:
          width 0.3s,
          background 0.3s;
      }

      .debug-panel {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 6px;
        font-size: 14px;
      }

      .debug-panel h3 {
        margin-bottom: 10px;
        color: #4a6cf7;
      }

      .debug-toggle {
        color: #4a6cf7;
        text-decoration: underline;
        cursor: pointer;
        margin-top: 10px;
        display: inline-block;
      }

      .api-response {
        margin-top: 10px;
        padding: 10px;
        background: #eee;
        border-radius: 4px;
        font-family: monospace;
        white-space: pre-wrap;
        display: none;
        max-height: 200px;
        overflow-y: auto;
      }

      .server-status {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
      }

      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-online {
        background-color: #28a745;
      }

      .status-offline {
        background-color: #dc3545;
      }

      .try-again {
        margin-top: 15px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Reset Your Password</h1>
        <p>Create a new password for your account</p>
      </div>

      <div class="form-container">
        <div class="token-info">
          Token detected: <span id="token-display"></span>
        </div>

        <div id="message" class="message"></div>

        <form id="resetForm">
          <div class="form-group">
            <label for="password">New Password</label>
            <input
              type="password"
              id="password"
              name="password"
              placeholder="Enter your new password"
              required
            />
            <div class="password-strength">
              <div class="password-strength-bar" id="passwordStrengthBar"></div>
            </div>

            <div class="password-requirements">
              <strong>Password must include:</strong>
              <ul id="passwordRequirements">
                <li id="reqLength">At least 8 characters</li>
                <li id="reqUppercase">One uppercase letter</li>
                <li id="reqLowercase">One lowercase letter</li>
                <li id="reqNumber">One number</li>
                <li id="reqSpecial">One special character</li>
              </ul>
            </div>
          </div>

          <div class="form-group">
            <label for="confirmPassword">Confirm Password</label>
            <input
              type="password"
              id="confirmPassword"
              name="confirmPassword"
              placeholder="Confirm your new password"
              required
            />
          </div>

          <button type="submit" id="submitBtn">Reset Password</button>
        </form>

        <div class="debug-panel">
          <h3>Server Connection</h3>
          <div class="server-status">
            <div class="status-indicator" id="serverStatus"></div>
            <span id="serverStatusText">Checking server status...</span>
          </div>

          <div class="debug-toggle" id="debugToggle">Show API details</div>
          <div id="apiDetails" style="display: none; margin-top: 15px">
            <p>
              Endpoint:
              <code id="endpointUrl"
                >http://localhost:3001/password-update?token=...</code
              >
            </p>
            <p>
              Request body:
              <code id="requestBody">{ "password": "••••••••" }</code>
            </p>
            <div id="apiResponse" class="api-response"></div>
          </div>

          <div class="try-again">
            <button id="retryBtn" style="width: auto; padding: 8px 16px">
              Retry Connection
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("resetForm");
        const messageDiv = document.getElementById("message");
        const submitBtn = document.getElementById("submitBtn");
        const tokenDisplay = document.getElementById("token-display");
        const passwordInput = document.getElementById("password");
        const confirmInput = document.getElementById("confirmPassword");
        const strengthBar = document.getElementById("passwordStrengthBar");
        const debugToggle = document.getElementById("debugToggle");
        const apiDetails = document.getElementById("apiDetails");
        const endpointUrl = document.getElementById("endpointUrl");
        const requestBody = document.getElementById("requestBody");
        const apiResponse = document.getElementById("apiResponse");
        const serverStatus = document.getElementById("serverStatus");
        const serverStatusText = document.getElementById("serverStatusText");
        const retryBtn = document.getElementById("retryBtn");

        // Password requirement elements
        const reqLength = document.getElementById("reqLength");
        const reqUppercase = document.getElementById("reqUppercase");
        const reqLowercase = document.getElementById("reqLowercase");
        const reqNumber = document.getElementById("reqNumber");
        const reqSpecial = document.getElementById("reqSpecial");

        // Get token from URL
        const urlParams = new URLSearchParams(window.location.search);
        let token = urlParams.get("token");

        // If no token in URL, create a mock one for demonstration
        if (!token) {
          token = "mock-token-" + Math.random().toString(36).substring(2, 15);
          // Update URL without refreshing page
          const newUrl =
            window.location.origin +
            window.location.pathname +
            "?token=" +
            token;
          window.history.replaceState({}, "", newUrl);
        }

        // Display token
        if (token) {
          tokenDisplay.textContent = token.substring(0, 20) + "...";
        } else {
          tokenDisplay.textContent = "No token found in URL";
          tokenDisplay.style.color = "red";
        }

        // Update endpoint URL display
        endpointUrl.textContent = `http://localhost:3001/password-update?token=${token.substring(0, 20)}...`;

        // Check server status
        checkServerStatus();

        // Toggle debug info
        debugToggle.addEventListener("click", function () {
          if (apiDetails.style.display === "none") {
            apiDetails.style.display = "block";
            debugToggle.textContent = "Hide API details";
          } else {
            apiDetails.style.display = "none";
            debugToggle.textContent = "Show API details";
          }
        });

        // Retry connection
        retryBtn.addEventListener("click", checkServerStatus);

        // Password strength indicator
        passwordInput.addEventListener("input", function () {
          const password = passwordInput.value;
          updatePasswordStrength(password);
          updateRequestBodyDisplay();
        });

        confirmInput.addEventListener("input", updateRequestBodyDisplay);

        function updateRequestBodyDisplay() {
          const password = passwordInput.value;
          requestBody.textContent = JSON.stringify({
            password: password.length > 0 ? "••••••••" : "",
          });
        }

        function updatePasswordStrength(password) {
          let strength = 0;

          // Check requirements
          const hasLength = password.length >= 8;
          const hasUppercase = /[A-Z]/.test(password);
          const hasLowercase = /[a-z]/.test(password);
          const hasNumber = /\d/.test(password);
          const hasSpecial = /[^A-Za-z0-9]/.test(password);

          // Update requirement indicators
          reqLength.className = hasLength ? "valid" : "";
          reqUppercase.className = hasUppercase ? "valid" : "";
          reqLowercase.className = hasLowercase ? "valid" : "";
          reqNumber.className = hasNumber ? "valid" : "";
          reqSpecial.className = hasSpecial ? "valid" : "";

          // Calculate strength
          if (hasLength) strength += 20;
          if (hasUppercase) strength += 20;
          if (hasLowercase) strength += 20;
          if (hasNumber) strength += 20;
          if (hasSpecial) strength += 20;

          // Update strength bar
          strengthBar.style.width = strength + "%";

          // Set color based on strength
          if (strength < 40) {
            strengthBar.style.background = "#dc3545"; // Red
          } else if (strength < 80) {
            strengthBar.style.background = "#ffc107"; // Yellow
          } else {
            strengthBar.style.background = "#28a745"; // Green
          }
        }

        async function checkServerStatus() {
          serverStatus.className = "status-indicator";
          serverStatusText.textContent = "Checking server status...";

          try {
            // Try to connect to the server
            const response = await fetch("http://localhost:3001/health", {
              method: "HEAD",
              cache: "no-store",
            });

            if (response.status < 400) {
              serverStatus.className = "status-indicator status-online";
              serverStatusText.textContent = "Server is online";
            } else {
              throw new Error(`Server returned status: ${response.status}`);
            }
          } catch (error) {
            serverStatus.className = "status-indicator status-offline";
            serverStatusText.textContent =
              "Server is offline or not responding";
            console.error("Server status check failed:", error);
          }
        }

        form.addEventListener("submit", async function (e) {
          e.preventDefault();

          // Get form values
          const password = document.getElementById("password").value;
          const confirmPassword =
            document.getElementById("confirmPassword").value;

          // Validate passwords match
          if (password !== confirmPassword) {
            showMessage("Passwords do not match", "error");
            return;
          }

          // Validate password strength
          if (!validatePassword(password)) {
            showMessage("Password does not meet requirements", "error");
            return;
          }

          // If no token in URL, show error
          if (!token) {
            showMessage("Invalid or missing reset token", "error");
            return;
          }

          // Disable submit button and show loading state
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<span class="loading"></span> Processing...';

          try {
            // Show API request details
            apiResponse.style.display = "block";
            apiResponse.textContent = "Sending request to API...";

            // Make the actual API request
            const response = await fetch(
              `http://localhost:3001/auth/password-update?token=${encodeURIComponent(token)}`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ password: password }),
              },
            );

            // Store the response text for debugging
            const responseText = await response.text();

            // Display the raw response
            apiResponse.textContent = responseText;

            // Check if response is HTML (error page)
            if (
              responseText.trim().startsWith("<!DOCTYPE") ||
              responseText.trim().startsWith("<html>") ||
              responseText.includes("</html>")
            ) {
              // This is an HTML error page from the server
              if (response.status === 400) {
                throw new Error(
                  "Invalid or expired token. Please request a new password reset.",
                );
              } else {
                throw new Error(
                  "Server returned an error page. Please try again later.",
                );
              }
            }

            // Try to parse as JSON
            let data;
            try {
              data = JSON.parse(responseText);
            } catch (parseError) {
              throw new Error(
                `Invalid response from server: ${responseText.substring(0, 100)}...`, parseError
              );
            }

            if (!response.ok) {
              throw new Error(
                data.message || `Server returned status: ${response.status}`,
              );
            }

            if (data.success) {
              showMessage(
                "Password reset successfully! You can now login with your new password.",
                "success",
              );
              form.reset();
            } else {
              throw new Error(data.message || "Error resetting password");
            }
          } catch (error) {
            console.error("Error:", error);

            // Provide specific error message for JSON parsing issues
            if (error.message.includes("Invalid or expired token")) {
              showMessage(error.message, "error");
            } else if (error.message.includes("Failed to fetch")) {
              showMessage(
                "Cannot connect to the server. Please make sure it is running on localhost:3001.",
                "error",
              );
            } else {
              showMessage(
                error.message || "Network error. Please try again.",
                "error",
              );
            }
          } finally {
            // Re-enable submit button
            submitBtn.disabled = false;
            submitBtn.innerHTML = "Reset Password";
          }
        });

        function showMessage(message, type) {
          messageDiv.textContent = message;
          messageDiv.className = "message " + type;
        }

        function validatePassword(password) {
          // At least 8 characters, one uppercase, one lowercase, one number, one special character
          const regex =
            /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
          return regex.test(password);
        }
      });
    </script>
  </body>
</html>
